# S04E02 - Trombinoclock - Introduction aux SGBD

## Menu du jour

```
### Matin 

- Correction
  - route `/promo/:id/students`
  - route `/student/:id`
  - dossier public
  - librairie CSS

- Mod√©lisation de base de donn√©es
  - MCD
  - MLD
  - MPD

### Apr√®s-midi

- D√©couverte PostgreSQL
  - Vocabulaire
  - Serveur `Postgres`
  - Client terminal `psql`
  - Requ√™tes `SQL`
  - Client Node `pg`
```


## Commit convention

https://www.conventionalcommits.org/en/v1.0.0/

- `feat:` √©criture d'une fonctionnalit√©
- `docs:` √©criture de documentation
- `config:` configuration et mise en place
- `chore:` retirer du code inutilis√©
- `refactor:` modification/am√©lioration de code existant SANS CHANGER la fonctionnalit√© d√©j√† en place
- `fix:` r√©gler un bug/probl√®me

(+ (bonus) je rajoute un emoji, simplement pour faire joli sur Github)


## Namming de m√©thode

```
renderStudentPage --> ‚ùå impression qu'on renvoie la page d'1 student
renderAllStudents --> ‚ùå donne l'impression qu'on renvoie TOUS les √©l√®ves de la BDD
renderListStudent --> ‚ùå donne l'impression qu'on renvoie TOUS les √©l√®ves de la BDD
renderStudentListPage --> ‚ùå donne l'impression qu'on renvoie TOUS les √©l√®ves de la BDD
renderListOfStudentsPage --> ‚ùå donne l'impression qu'on renvoie TOUS les √©l√®ves de la BDD
renderAllStudentsPromo -> ‚úÖ

renderPromoStudents -> ‚úÖ 
renderAllStudentsOfPromo -> ‚úÖ
```

## M√©thodes `find` et `some` et `filter`


```js
const fruits = [
  { name: "Kiwi", quantity: 42},
  { name: "Apple", quantity: 2},
  { name: "Pear", quantity: 66}
];

const kiwi = fruits.find(fruit => fruit.name == "Kiwi"); // Renvoie l'√©l√©ment du tableau qui match la fonction
console.log(kiwi);

const isKiwiPresent = fruits.some(fruit => fruit.name === "Kiwi"); // Renvoie un boolean
console.log(isKiwiPresent);

const flag1 = fruits.some(fruit => fruit.quantity === 42);
console.log(flag1); // true 

const flag2 = fruits.some(fruit => fruit.quantity === 50);
console.log(flag2); // false

// On r√©cup√®re les fruits dont la quantit√© est plus grande que 10 !
const topBasketFruits = fruits.filter(fruit => fruit.quantity > 10);
// topBasketFruits = [{ name: "Kiwi", quantity: 42}, { name: "Pear", quantity: 66}]

const fruitsNames = topBasketFruits.map(fruit => fruit.name); // ["Kiwi", "Pear"]
```

## Comprendre les m√©thodes des arrays

- `[] => true/false` `.some`
- `[] => X` : `.find`

| Objectif | Visuel | Methode appropri√©e
| -- | -- | -- |
| A partir d'un tableau, savoir si au moins un √©l√©ment match un crit√®re | `[] => true/false` | `.some`
| A partir d'un tableau, r√©cup√©re le premier √©l√©ment qui match un crit√®re | `[] => Element` | `.find`
| A partir d'un tableau, r√©cup√©rer tous les √©l√©ments qui matchent un crit√®re | `[] => []` | `.filter`
| A partir d'un tableau, je veux faire subir une op√©ration √† tous les √©l√©ments de ce tableau | `[X] => [Y]`, | `.map`


## Base de donn√©es - Motivation

- `JSON` : 
  - c'est bien, mais s'il faut le renvoyer et le remplacer √† chaque fois, c'est p√©nible
  - s'il faut le modifier programmatiquement, c'est p√©nible. Essayez en Node.js de changer le contenu d'un fichier sur sa machine

- On a besoin d'un syst√®me dont la vocation est de STOCKER, STRUCTURE, FOURNIR de la donn√©es. 
  - **Syst√®me de Gestion de Bases de Donn√©es**

## PostgreSQL

- `SGBD` (üá¨üáß DBMS) = 
  - Syst√®me de Gestion de Bases de Donn√©es (Database Management Syst√®me)
  - **Serveur** (camion qui roule en permanence et dans lequel on trouve des colis)

- `BDD` (üá¨üáß DB) =
  - Base de donn√©es (Database)
  - Une sorte de "colis", structur√©

- `Tables`
  - Une BDD est compos√©es de plusieurs "tables" qui structure nos donn√©es
  - ex : `student` // `promo`

- `Champs`
  - Les propri√©t√©s d'une table
    - ex : pour la table `student` : un pr√©nom, un nom, un photo_url, etc...

R√©pond √† la question : **Comment stocker la donn√©es ??**

## Mod√©lisation

R√©pond √† la question : **Quelles donn√©es stocker ??**

## M√©thodologie classique en mod√©lisation de donn√©es : MERISE 

- üá´üá∑ franco-fran√ßaise, mais une des m√©thodes les plus utilis√©s pour mod√©liser.
- normalis√© : r√®gles √† respecter pour bien le faire.

`MERISE` = faire : 
- un `MCD` : Mod√®le Conceptuel de Donn√©es 
- un `MLD` : Mod√®le Logique de Donn√©es 
- un `MPD` : Mod√®le physique de Donn√©es 

## MCD - Mod√®le Conceptuel de Donn√©es

Le MCD est un exercice tr√®s acad√©mique, tr√®s normalis√©, dont l'expression se fait g√©n√©ralement sous la forme d'un SCHEMA (sch√©ma `Entit√©-Relation` ou sch√©ma `Entit√©-Association`)

Objectif : mod√©liser CONCEPTUELLEMENT un probl√®me de la vie courante, afin de l'expliquer √† mamie !

On le r√©dige dans la langue la plus proche du probl√®me ! (üá´üá∑ !)

Ce n'est pas un document TECHNIQUE :
- on parle pas d'`ID`
- on parle pas de `table`/`champs`/`enregistrement`
- on parle pas de cl√© primaire/cl√© √©trnag√®re
- 

Brouillon de nos donn√©es :

- lister les **entit√©s** de notre probl√®me
  - lister les **discriminants** (**identifiant**) de nos entit√©s : un attribut qui caract√©rise de mani√®re unique une entit√©
- lister les **attributs** de nos entit√©s
- lister les **associations** entre nos entit√©s : attention

```
Etudiant : code etudiant, pseudo github, pr√©nom, nom, URL de photo

Promotion : code promotion, nom, URL Github

un √©tudiant APPARTIENT √† une et une seule Promotion
```

On passe au dessin : 
- carr√© pour les entit√©s et leurs attributs
- souligner le discriminent
- rond pour le nom de l'association (+ trait entre les deux)
- de part et d'autre de l'association, on pr√©cise les **cardinalit√©s** de cette association. 

### Sch√©matisation du MCD

Quel outil : 
- papier/crayon
- drawio (Google)
- tldraw
- excalidraw
- MoCoDo (sous forme de code)

Conseil : 
- installer l'extension VSCode `Draw.io Integration` 
- cr√©er un fichier avec l'extension `.drawio`

![](../resources/screens/mcd.png)


## MLD - Mod√®le Logique de Donn√©es

Objectif : traduire le MCD en vu d'√™tre impl√©menter dans un vrai syst√®me de gestion de base de donn√©es. 

- traduire les `entit√©s` en nom pour nos `tables`
- traduire les `attributs` en nom de `champs`
- pr√©ciser (parfois !) les types de donn√©es qu'on stocke (ex: chaine de caract√®re, nombre...)
- traduire les `associations`, plusieurs : 
  - cl√©s primaire/√©trang√®res (on va aller vite, on le reverra !)
  - tables de liaisons (fin de saison)

C'est un exercice MOINS acad√©mique :
- plusieurs formats sont possibles pour les r√©diger :
  - du texte fera bien l'affaire
  - un sch√©ma est aussi appr√©ciable

**Conventions de nommage** : 
- `snake_case`, sans majuscule
- nom de tables au `singulier`, en minuscule


**Disclamer vocabulaire** :
Eviter au maximum le mot "`relation`" car en angalais `relation` veut dire "`table`". Pr√©f√©rer le mot association. Mais vous le trouverez PARTOUT, y compris dans les documentations de BDD ! 


**[Version Texte]** : 

```
student (
  id                      (nombre)
  first_name              (chaine de caract√®re)
  last_name               (chaine de caract√®re)
  profile_picture_url     (chaine de caract√®re - URL)
  github_username         (chaine de caract√®re)
  promo_id                (#FK->promo.id)
)

promo (
  id,                     (nombre)
  name,                   (chaine de caract√®re - 200 caract√®res max)
  github_organization     (chaine de caract√®re - URL)
)
```

**[Version Schematique]** : 

![](../resources/screens/mld.png)

### R√®gle de traduction de l'association

Regarder les cardinalit√©s 

```
ETUDIANT <---- 1,1 ----> APPARTIENT <---- 0,N ----> PROMOTION
              ^                           ^
              max(1,1) = 1                max(0,N) = N

==> Ici, nous avons donc affaire √† une association 1-N = `One-To-Many`
```

Il y a trois type d'associations : 
- `One-to-One` : 
  - traduire par un simple ajout d'attribut
- `One-To-Many`
  - on rajoute un ID sur une table qui pointe vers l'autre
  - cet id se nomme une "cl√© √©trang√®re"
- `Many-To-Many`
  - on rajoute une table de liaison (voir fin de saison)


> Exemple, ici on a rajout√© la cl√© √©trang√®re `promo_id` dans la table `student` qui pointe vers la cl√© primaire `id` de la table `promo` (ie., vers `promo.id`).

> Cette cl√© fait une sorte de r√©f√©rence (purement mental) vers l'autre table


## MPD - Mod√®le Physique de donn√©es

Actuelle impl√©mentation de la structure de la base de donn√©es dans un syst√®me de gestion de base de donn√©es qu'on choisit ! --> demain

--> car aujourd'hui, on a besoin de comprendre comment fonctionne un SGBD, comment il est structur√©, et comment on communique avec lui ! 

Planning journ√©e : 
- Slides avant midi
- MIDI (allumer vos VM √† la fin de la pause)
- On se connecte √† un SGBD Postgres "distant" (pour voir !)
- On fait quelques requ√™tes √† Postgres (pour voir !)
- On se connecte √† ce SGBD Postgres via Node (pour voir !)

Demain : 
- On installe Postgres en local
- On cr√©√© nos donn√©es en local ! 

## Se connecter √† un serveur Postgres sur les serveur (physique) de Oclock !

![](../resources/screens/postgres.png)

On a besoin du VPN -> le t√©l√©porteur lanc√©.

- Ouvrir un terminal dans la VM T√©l√©porteur
- `psql -h pg.oclock.lan -U etudiant -d trombi`
  - mdp : `js4life`

- On r√©cup√®re un prompt psql : `trombi =>`

### `psql` 

`psql` = client terminal pour se connecter √† Postgres

Il existe d'autres clients pour se connecter √† Postgres, certains plus visuels que d'autres : -
- `psql` : terminal
- `pgAdmin` : GUI (interface graphique)
- `DBeaver` : GUI
- `pg` : Node.js


Rappel `\` : 
  - (MAC) : `OPT + MAJ + /`
  - (PC) : `ALT GR + 8`

- `\conninfo` = affiche des informations sur la connexion actuelle entre notre client et le serveur Postgres
- `\l` = affiche toutes les bases de donn√©es pr√©sente dans le serveur Postgres
- `\dt` = liste les **tables** pr√©sentes dans la BDD dans laquelle on est connect√©e 

- `\d nom_de_la_table` = liste les champs d'une table

- `\s` = liste l'historique des commandes pr√©c√©dentes (ou fl√®che vers le haut)

Note : pour quitter une "liste" dans `psql`, appuyez simplement sur `q`

- `exit` : quitter psql
- `CTRL + D` : quitter psql
- `CTRL + C` : annuler la query en cours pas termin√©e


## SQL - Structured Query Langage

C'est un langage (universel dans le sens o√π il est utilis√© par plusieurs SGBD dif√©rent) pour requeter des donn√©es dans une BDD !

Si on cherche une commande particuli√®re, [la documentation est votre amie](https://sql.sh/) !

Notre premi√®re requ√™te SQL : 

- `SELECT * FROM "student";`

Attention : 
- ne pas oublier le `;`
- pour les noms de table, ajouter des guillemets double `"`
- pour les noms de champs, ajouter des guillemets double `"`
- pour les valeurs string, ajouter des giullemets simple `'`
- sensible √† la case (`F ‚â† f`)

```sql
-- Selectionner tous les champs de la table student
SELECT * FROM "student";

-- Selectionner uniquement les pr√©noms des students
SELECT "first_name" FROM "student";

-- Selectionner uniquement les pr√©noms et les noms des students
SELECT "first_name", "last_name" FROM "student";

-- Selectionner la promotion dont le nom est Cheesecake
SELECT * FROM "promo" WHERE "name" = 'Cheesecake';

-- Selectionner un √©tudiant dont le pr√©nom est Alex et le nom de famille est Terry
SELECT * FROM "student" WHERE "first_name" = 'Alex' AND "last_name" = 'Terry';

-- Selectionner les √©tudiants dont le pr√©noom est Alex ou Tom
SELECT * FROM "student" WHERE "first_name" = 'Alex' OR "first_name" = 'Tom';

-- Selectionner les √©l√®ves dont le pr√©nom commence par un A
-- % s'appelle un wildcard (sorte d'expression r√©guliere) = n'importe quel caract√®re
SELECT * FROM "student" WHERE "first_name" LIKE 'A%';
SELECT * FROM "student" WHERE "first_name" ILIKE 'a%'; -- insensible √† la casse (majuscule/minuscule)

-- Selectionner toutes les promos dont le dernier caract√®re est 'e'
SELECT * FROM "promo" WHERE "name" LIKE '%e';
```

```sql
-- Trier
SELECT * FROM "promo" ORDER BY "name" ASC; -- Ordre croissant (alphab√©tique)
SELECT * FROM "promo" ORDER BY "name" DESC; -- Ordre d√©croissant (alphab√©tique)

-- Limiter
SELECT * FROM "promo" LIMIT 3;
```

```sql
-- Evidemment, on peut combiner toutes ces filtres
SELECT "id", "first_name", "last_name" FROM "student" WHERE "id" = 5 OR "first_name" ILIKE 'a%' ORDER BY "first_name" ASC LIMIT 3;
```

```sql
-- ==== Aggr√©gation ===

-- Compter
SELECT COUNT(*) FROM "student"; -- Nombre d'√©tudiant total dans la table
SELECT COUNT(*) FROM "student" WHERE "promo_id" = 663; -- Nombre d'√©tudiant total qui respecte la condition du WHERE

-- SELECT COUNT(*) FROM "student" WHERE "promo" = 'Cheesecake'; -- Pas possible jusqu'√† ce qu'on ait les jointure
-- Spoiler alerte : on se cassera "un peu" la t√™te √† partir de S04E507
SELECT COUNT(*) FROM "student" JOIN "promo" ON promo.id = student.promo_id WHERE promo.name = 'Cheesecake';
```

## Connexion √† Postgres depuis Node.js

Nous avons besoin d'un "client" / "driver" pour se faire !

Il s'appelle : `pg`. C'est un module `npm` !
